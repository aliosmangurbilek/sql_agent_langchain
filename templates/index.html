<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangChain SQL Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ LangChain SQL Agent</h1>
            <p>Natural language to SQL queries with interactive charts</p>
            <button id="theme-toggle" class="btn btn-secondary theme-toggle">üåô Dark Mode</button>
        </header>

        <main>
            <!-- Worker Status Panel -->
            <section class="worker-status-section">
                <h2>üîß Schema Worker Status</h2>
                <div class="status-grid">
                    <div class="status-card worker-card">
                        <div class="status-header">
                            <span class="status-label">Worker</span>
                            <span id="worker-status" class="status-indicator offline">‚óè</span>
                        </div>
                        <div class="status-content">
                            <span id="worker-status-text">Checking...</span>
                        </div>
                    </div>
                    <div class="status-card active-db-card">
                        <div class="status-header">
                            <span class="status-label">Active DB</span>
                            <button id="refresh-status-btn" class="btn btn-mini">üîÑ</button>
                        </div>
                        <div class="status-content">
                            <span id="active-db-name">None</span>
                        </div>
                    </div>
                    <div class="status-card cached-dbs-card">
                        <div class="status-header">
                            <span class="status-label">Cached DBs</span>
                            <span id="cached-db-count" class="badge">0</span>
                        </div>
                        <div class="status-content">
                            <div id="cached-db-list">No cached connections</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Database Management Section -->
            <section class="database-section">
                <h2>üóÑÔ∏è Database Management</h2>
                <div class="database-controls">
                    <div class="input-group">
                        <label for="base-db-uri">Base Database URL:</label>
                        <div class="input-row">
                            <input type="text" id="base-db-uri" placeholder="postgresql+asyncpg://user:pass@localhost/" value="">
                            <button id="save-base-uri-btn" class="btn btn-secondary">Save</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="database-switcher">Switch Active Database:</label>
                        <div class="input-row">
                            <input type="text" id="database-switcher" placeholder="database_name" value="">
                            <button id="switch-db-btn" class="btn btn-primary">Switch DB</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Traditional Configuration Section -->
            <section class="config-section">
                <h2>‚öôÔ∏è Query Configuration</h2>
                <div class="input-group">
                    <label for="db-uri">Current Database URI:</label>
                    <div class="input-row">
                        <input type="text" id="db-uri" placeholder="postgresql://user:pass@localhost:5432/db" value="">
                        <button id="test-connection-btn" class="btn btn-test">Test Connection</button>
                    </div>
                </div>
                <div id="test-connection-result" class="connection-status"></div>
                <div class="input-group">
                    <label for="model-select">Model:</label>
                    <div class="model-selection">
                        <select id="model-select" disabled>
                            <option value="">Loading models...</option>
                        </select>
                        <button id="refresh-models-btn" class="btn btn-refresh">üîÑ</button>
                    </div>
                </div>
            </section>

            <section class="query-section">
                <h2>Ask a Question</h2>
                <div class="input-group">
                    <label for="question">Natural Language Query:</label>
                    <textarea id="question" rows="3" placeholder="e.g., Show me the top 10 customers by revenue"></textarea>
                </div>

                <div class="input-group">
                    <label><input type="checkbox" id="use-llm"> Enhance charts with LLM</label>
                </div>

                <div class="button-group">
                    <button id="run-query" class="btn btn-primary" title="Execute the query and show SQL plus data results">üîç Fetch Data</button>
                    <button id="run-chart" class="btn btn-secondary" title="Execute the query and display a chart from the results">üìä Generate Chart</button>
                </div>
            </section>

            <section class="results-section">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="sql">SQL Query</button>
                    <button class="tab-btn" data-tab="data">Data Results</button>
                    <button class="tab-btn" data-tab="chart">Chart</button>
                    <button class="tab-btn" data-tab="schema-log">Schema Log</button>
                </div>

                <div class="tab-content">
                    <div id="sql-tab" class="tab-pane active">
                        <h3>Agent Answer</h3>
                        <pre><code id="sql-output">No query executed yet.</code></pre>
                        <div id="embedding-suggestions"></div>
                    </div>

                    <div id="data-tab" class="tab-pane">
                        <h3>Query Results</h3>
                        <pre><code id="data-output">No data available.</code></pre>
                    </div>

                    <div id="chart-tab" class="tab-pane">
                        <h3>Visualization</h3>
                        <div id="chart-output">No chart generated yet.</div>
                    </div>

                    <div id="schema-log-tab" class="tab-pane">
                        <h3>üìä Real-time Schema Changes</h3>
                        <div class="schema-log-controls">
                            <button id="clear-schema-log" class="btn btn-secondary btn-sm">Clear Log</button>
                            <button id="toggle-schema-monitoring" class="btn btn-primary btn-sm" data-monitoring="false">Start Monitoring</button>
                        </div>
                        <div id="schema-log-container" class="schema-log">
                            <div class="log-entry info">
                                <span class="timestamp">Ready</span>
                                <span class="message">Schema change monitoring ready. Click "Start Monitoring" to begin.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="status-section">
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                
                <div id="progress-container" class="progress-container hidden">
                    <div class="progress-header">
                        <h4 id="progress-title">Processing your request...</h4>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-message" class="progress-message">Initializing...</div>
                    <div id="progress-steps" class="progress-steps"></div>
                </div>
                
                                <div id="error" class="error hidden"></div>
            </section>

        </main>
    </div>
</body>
</html>
            </section>
        </main>
    </div>

    <!-- Application JavaScript modules -->
    <script src="{{ url_for('static', filename='js/ui-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/worker-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/schema-logger.js') }}"></script>
    <script src="{{ url_for('static', filename='js/model-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config-manager.js') }}"></script>  
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
