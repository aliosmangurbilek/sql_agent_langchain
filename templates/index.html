<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangChain SQL Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ LangChain SQL Agent</h1>
            <p>Natural language to SQL queries with interactive charts</p>
            <button id="theme-toggle" class="btn btn-secondary theme-toggle">üåô Dark Mode</button>
        </header>

        <main>
            <section class="config-section">
                <h2>Configuration</h2>
                <div class="input-group">
                    <label for="db-uri">Database URI:</label>
                    <div class="input-row">
                        <input type="text" id="db-uri" placeholder="postgresql://user:pass@localhost:5432/db" value="">
                        <button id="test-connection-btn" class="btn btn-test">Test Connection</button>
                    </div>
                </div>
                <div id="test-connection-result" class="connection-status"></div>
                <div class="input-group">
                    <label for="model-select">Model:</label>
                    <div class="model-selection">
                        <select id="model-select" disabled>
                            <option value="">Loading models...</option>
                        </select>
                        <button id="refresh-models-btn" class="btn btn-refresh">üîÑ</button>
                    </div>
                </div>
            </section>

            <section class="query-section">
                <h2>Ask a Question</h2>
                <div class="input-group">
                    <label for="question">Natural Language Query:</label>
                    <textarea id="question" rows="3" placeholder="e.g., Show me the top 10 customers by revenue"></textarea>
                </div>

                <div class="button-group">
                    <button id="run-query" class="btn btn-primary" title="Execute the query and show SQL plus data results">üîç Fetch Data</button>
                    <button id="run-chart" class="btn btn-secondary" title="Execute the query and display a chart from the results">üìä Generate Chart</button>
                </div>
            </section>

            <section class="results-section">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="sql">SQL Query</button>
                    <button class="tab-btn" data-tab="data">Data Results</button>
                    <button class="tab-btn" data-tab="chart">Chart</button>
                </div>

                <div class="tab-content">
                    <div id="sql-tab" class="tab-pane active">
                        <h3>Agent Answer</h3>
                        <pre><code id="sql-output">No query executed yet.</code></pre>
                        <div id="embedding-suggestions"></div>
                    </div>

                    <div id="data-tab" class="tab-pane">
                        <h3>Query Results</h3>
                        <pre><code id="data-output">No data available.</code></pre>
                    </div>

                    <div id="chart-tab" class="tab-pane">
                        <h3>Visualization</h3>
                        <div id="chart-output">No chart generated yet.</div>
                    </div>
                </div>
            </section>

            <section class="status-section">
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                <div id="error" class="error hidden"></div>
            </section>
        </main>
    </div>

    <script>
        // Model loading functionality
        async function loadModels() {
            const modelSelect = document.getElementById('model-select');
            const refreshBtn = document.getElementById('refresh-models-btn');
            
            // Disable during loading
            modelSelect.disabled = true;
            refreshBtn.disabled = true;
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            
            try {
                const response = await fetch('/api/models');
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    modelSelect.innerHTML = '';
                    
                    // Group models by type
                    const freeModels = result.models.filter(m => m.is_free);
                    const paidModels = result.models.filter(m => !m.is_free);
                    
                    // Add free models first
                    if (freeModels.length > 0) {
                        const freeGroup = document.createElement('optgroup');
                        freeGroup.label = 'üÜì Free Models';
                        freeModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.name} (Free)`;
                            if (model.description) {
                                option.title = model.description;
                            }
                            freeGroup.appendChild(option);
                        });
                        modelSelect.appendChild(freeGroup);
                    }
                    
                    // Add paid models
                    if (paidModels.length > 0) {
                        const paidGroup = document.createElement('optgroup');
                        paidGroup.label = 'üí∞ Paid Models';
                        paidModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.name} ($${model.pricing.prompt}/1M tokens)`;
                            if (model.description) {
                                option.title = model.description;
                            }
                            paidGroup.appendChild(option);
                        });
                        modelSelect.appendChild(paidGroup);
                    }
                    
                    // Select default model (first free model or deepseek/deepseek-chat)
                    const defaultModel = freeModels.find(m => m.id.includes('deepseek')) || freeModels[0];
                    if (defaultModel) {
                        modelSelect.value = defaultModel.id;
                    }
                    
                } else {
                    modelSelect.innerHTML = '<option value="">Error loading models</option>';
                    console.error('Failed to load models:', result.error);
                }
            } catch (error) {
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
                console.error('Error loading models:', error);
            } finally {
                modelSelect.disabled = false;
                refreshBtn.disabled = false;
            }
        }
        
        // Test Connection functionality
        document.getElementById('test-connection-btn').addEventListener('click', async () => {
            const dbUri = document.getElementById('db-uri').value;
            const resultDiv = document.getElementById('test-connection-result');
            
            if (!dbUri) {
                resultDiv.innerHTML = '<span class="error">Please enter a database URI first!</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="loading">Testing connection...</span>';

            try {
                const response = await fetch('/api/test_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ db_uri: dbUri }),
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<span class="success">‚úÖ Connection successful!</span>`;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå Connection failed: ${result.error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        });
        
        // Refresh models button
        document.getElementById('refresh-models-btn').addEventListener('click', loadModels);
        
        // Load models when page loads
        document.addEventListener('DOMContentLoaded', loadModels);
    </script>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
